name: LaTeX CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    # Permissions needed for GitHub Pages deployment
    permissions:
      contents: write      # For creating releases
      pages: write         # For deploying to Pages
      id-token: write      # For Pages deployment authentication

    container:
      image: danteev/texlive:latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: false

    - name: Cache apt packages
      uses: actions/cache@v4
      with:
        path: /var/cache/apt/archives
        key: apt-${{ runner.os }}-${{ hashFiles('.github/workflows/latex-ci.yml') }}
        restore-keys: |
          apt-${{ runner.os }}-

    - name: Install Git LFS and fetch files
      run: |
        apt-get update -qq
        apt-get install -y git-lfs git
        git config --global --add safe.directory /__w/BookThesis/BookThesis
        git lfs pull

    - name: Compile LaTeX document (full compilation)
      run: |
        chmod +x compile.sh
        ./compile.sh 1

    - name: Check for warnings and errors
      run: ./compile.sh 3

    - name: Upload PDF artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: libro-pdf
        path: build/*.pdf
        retention-days: 30

    - name: Show PDF information
      if: success()
      run: ./compile.sh 5

    - name: Validate PDF output
      if: success()
      run: |
        # Check if PDF exists
        if [ ! -f "build/Libro.pdf" ]; then
          echo "Error: PDF file not found at build/Libro.pdf"
          exit 1
        fi

        # Check if PDF is not empty (at least 1KB)
        PDF_SIZE=$(stat -c%s "build/Libro.pdf" 2>/dev/null || stat -f%z "build/Libro.pdf" 2>/dev/null)
        if [ "$PDF_SIZE" -lt 1024 ]; then
          echo "Error: PDF file is too small ($PDF_SIZE bytes). Likely corrupted or empty."
          exit 1
        fi

        # Check if file is actually a PDF (magic number check)
        if ! head -c 4 "build/Libro.pdf" | grep -q "^%PDF"; then
          echo "Error: File is not a valid PDF (missing PDF header)"
          exit 1
        fi

        echo "‚úì PDF validation passed"
        echo "  Size: $PDF_SIZE bytes ($(echo "scale=2; $PDF_SIZE/1024" | bc) KB)"

    - name: Install Pandoc for Style Guide compilation
      if: success() && github.ref == 'refs/heads/main'
      run: |
        echo "üì¶ Installing Pandoc for Style Guide PDF compilation..."
        apt-get update -qq
        apt-get install -y pandoc

    - name: Compile Style Guide PDF
      if: success() && github.ref == 'refs/heads/main'
      run: |
        echo "üìö Compiling Style Guide PDF..."

        # Create output directories
        mkdir -p build/markdown/pdf
        mkdir -p build/markdown/logs

        # Check if style guide exists
        if [ ! -f "docs/STYLE_GUIDE_DOC.md" ]; then
          echo "‚ö† Warning: docs/STYLE_GUIDE_DOC.md not found, skipping"
          exit 0
        fi

        # Preprocess markdown (handle GitHub-specific extensions)
        sed -E '
          s/^> \[!NOTE\]/> **Nota:**/g
          s/^> \[!WARNING\]/> **Advertencia:**/g
          s/^> \[!TIP\]/> **Consejo:**/g
          s/^> \[!IMPORTANT\]/> **Importante:**/g
          s/^> \[!CAUTION\]/> **Precauci√≥n:**/g
        ' docs/STYLE_GUIDE_DOC.md > build/markdown/temp_STYLE_GUIDE_DOC.md

        # Compile with pandoc
        pandoc build/markdown/temp_STYLE_GUIDE_DOC.md \
          --output=build/markdown/pdf/STYLE_GUIDE_DOC.pdf \
          --from=markdown+yaml_metadata_block \
          --to=pdf \
          --pdf-engine=lualatex \
          --pdf-engine-opt=-interaction=nonstopmode \
          --template=templates/thesis-template.tex \
          --variable=fontsize=12pt \
          --variable=papersize=a4 \
          --variable=geometry:left=3cm \
          --variable=geometry:right=3cm \
          --variable=geometry:top=2.54cm \
          --variable=geometry:bottom=2.54cm \
          --variable=linestretch=1.5 \
          --toc \
          --toc-depth=3 \
          --number-sections \
          > build/markdown/logs/STYLE_GUIDE_DOC.log 2>&1

        # Verify compilation succeeded
        if [ -f "build/markdown/pdf/STYLE_GUIDE_DOC.pdf" ]; then
          SIZE=$(du -h build/markdown/pdf/STYLE_GUIDE_DOC.pdf | cut -f1)
          echo "‚úì Style Guide PDF compiled successfully ($SIZE)"
        else
          echo "‚ùå Style Guide compilation failed"
          cat build/markdown/logs/STYLE_GUIDE_DOC.log
          exit 1
        fi

        # Clean up temp file
        rm -f build/markdown/temp_STYLE_GUIDE_DOC.md

    - name: Create/Update GitHub Release
      if: success() && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@5be0e66d93ac7ed76da52eca8bb058f665c3a5fe  # v2.4.2
      with:
        tag_name: latest
        name: Latest PDF Build
        body: |
          üìö Latest build of the book PDF

          **Commit:** ${{ github.sha }}
          **Date:** ${{ github.event.head_commit.timestamp }}
          **Author:** ${{ github.event.head_commit.author.name }}

          Download the PDF below ‚¨áÔ∏è
        files: build/Libro.pdf
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Prepare GitHub Pages content
      if: success() && github.ref == 'refs/heads/main'
      run: |
        mkdir -p pages

        # Copy main book PDF with error handling
        if ! cp build/Libro.pdf pages/Libro.pdf; then
          echo "Error: Failed to copy PDF to pages directory"
          exit 1
        fi

        # Copy HTML template
        if ! cp .github/pages-template/index.html pages/index.html; then
          echo "Error: Failed to copy index.html to pages directory"
          exit 1
        fi

        # Copy CSS file
        if ! cp .github/pages-template/styles.css pages/styles.css; then
          echo "Error: Failed to copy styles.css to pages directory"
          exit 1
        fi

        # Copy JavaScript file
        if ! cp .github/pages-template/main.js pages/main.js; then
          echo "Error: Failed to copy main.js to pages directory"
          exit 1
        fi

        # Copy Style Guide PDF if it exists (from markdown workflow)
        # This is optional - if it doesn't exist, we'll create a placeholder
        if [ -f "build/markdown/pdf/STYLE_GUIDE_DOC.pdf" ]; then
          cp build/markdown/pdf/STYLE_GUIDE_DOC.pdf pages/STYLE_GUIDE_DOC.pdf
          echo "‚úì Style Guide PDF copied from markdown build"
        else
          echo "‚ö† Style Guide PDF not found in markdown build"
          echo "Note: The Style Guide will be available after the markdown-pdf-ci workflow runs"
        fi

        echo "‚úì GitHub Pages content prepared successfully"
        ls -lah pages/

    - name: Upload Pages artifact
      if: success() && github.ref == 'refs/heads/main'
      uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa  # v3.0.1
      with:
        path: ./pages

    - name: Deploy to GitHub Pages
      if: success() && github.ref == 'refs/heads/main'
      uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e  # v4.0.5
      id: deployment
